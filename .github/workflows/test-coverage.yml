name: Test Coverage

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  test-coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm test -- --coverage --coverageReporters=text --coverageReporters=lcov --coverageReporters=html

      - name: Check coverage threshold
        id: coverage
        run: |
          # Run tests and generate coverage summary
          npm test -- --coverage --coverageReporters=text-summary --coverageReporters=json-summary --coverageReporters=lcov
          
          # Extract coverage percentages from JSON summary
          COVERAGE_LINES=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(Math.round(data.total.lines.pct));")
          COVERAGE_BRANCHES=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(Math.round(data.total.branches.pct));")
          COVERAGE_FUNCTIONS=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(Math.round(data.total.functions.pct));")
          COVERAGE_STATEMENTS=$(node -e "const fs = require('fs'); const data = JSON.parse(fs.readFileSync('coverage/coverage-summary.json')); console.log(Math.round(data.total.statements.pct));")
          
          echo "üìä Coverage Report:"
          echo "  Lines: ${COVERAGE_LINES}%"
          echo "  Branches: ${COVERAGE_BRANCHES}%"
          echo "  Functions: ${COVERAGE_FUNCTIONS}%"
          echo "  Statements: ${COVERAGE_STATEMENTS}%"
          
          # Set output for use in other steps
          echo "lines=${COVERAGE_LINES}" >> $GITHUB_OUTPUT
          echo "branches=${COVERAGE_BRANCHES}" >> $GITHUB_OUTPUT
          echo "functions=${COVERAGE_FUNCTIONS}" >> $GITHUB_OUTPUT
          echo "statements=${COVERAGE_STATEMENTS}" >> $GITHUB_OUTPUT
          
          # Fail if any coverage metric is below 80%
          THRESHOLD=80
          if [ "$COVERAGE_LINES" -lt $THRESHOLD ] || [ "$COVERAGE_BRANCHES" -lt $THRESHOLD ] || [ "$COVERAGE_FUNCTIONS" -lt $THRESHOLD ] || [ "$COVERAGE_STATEMENTS" -lt $THRESHOLD ]; then
            echo "‚ùå Coverage is below ${THRESHOLD}% threshold"
            echo "  Lines: ${COVERAGE_LINES}% (required: ${THRESHOLD}%)"
            echo "  Branches: ${COVERAGE_BRANCHES}% (required: ${THRESHOLD}%)"
            echo "  Functions: ${COVERAGE_FUNCTIONS}% (required: ${THRESHOLD}%)"
            echo "  Statements: ${COVERAGE_STATEMENTS}% (required: ${THRESHOLD}%)"
            exit 1
          else
            echo "‚úÖ All coverage metrics meet ${THRESHOLD}% threshold"
          fi

      - name: Comment PR with coverage
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverageData = JSON.parse(fs.readFileSync('coverage/coverage-summary.json'));
            const total = coverageData.total;
            
            const comment = `## üìä Test Coverage Report
            
            | Metric | Coverage | Status |
            |--------|----------|--------|
            | **Lines** | ${Math.round(total.lines.pct)}% | ${total.lines.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            | **Branches** | ${Math.round(total.branches.pct)}% | ${total.branches.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            | **Functions** | ${Math.round(total.functions.pct)}% | ${total.functions.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            | **Statements** | ${Math.round(total.statements.pct)}% | ${total.statements.pct >= 80 ? '‚úÖ' : '‚ùå'} |
            
            **Threshold:** 80%
            
            ${total.lines.pct >= 80 && total.branches.pct >= 80 && total.functions.pct >= 80 && total.statements.pct >= 80 
              ? '‚úÖ All coverage metrics meet the threshold!' 
              : '‚ùå Some coverage metrics are below the threshold. Please add more tests.'}`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Upload coverage to Codecov (optional)
        if: env.CODECOV_TOKEN != ''
        uses: codecov/codecov-action@v4
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        with:
          files: ./coverage/lcov.info
          fail_ci_if_error: false
          verbose: true

      - name: Upload coverage report artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

